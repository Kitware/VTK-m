# Ad-hoc build that runs in the ECP Hardware, concretely in OLCF Spock.
.spock_gcc_hip:
  variables:
    CCACHE_BASEDIR:          "/gpfs/alpine/csc331/scratch/"
    CCACHE_DIR:              "/gpfs/alpine/csc331/scratch/vbolea/ci/vtk-m/ccache"
    CUSTOM_CI_BUILDS_DIR:    "/gpfs/alpine/csc331/scratch/vbolea/ci/vtk-m/runtime"

    # -isystem= is not affected by CCACHE_BASEDIR, thus we must ignore it
    CCACHE_IGNOREOPTIONS:    "-isystem=*"
    CCACHE_NOHASHDIR:        "true"
    CCACHE_INSTALL_DIR:      "$CI_PROJECT_DIR/build"

    CMAKE_BUILD_TYPE:        "RelWithDebInfo"
    CMAKE_GENERATOR:         "Ninja"
    CMAKE_PREFIX_PATH:       "$CI_BUILDS_DIR/kokkos_install"

    KOKKOS_OPTS: >-
      -DCMAKE_INSTALL_PREFIX:PATH=$CI_BUILDS_DIR/kokkos_install
      -DCMAKE_CXX_COMPILER:FILEPATH=/opt/rocm-4.5.0/hip/bin/hipcc
      -DKokkos_ARCH_VEGA908:BOOL=ON

    # DefApps/default;craype;rocm;gcc should be loaded first
    JOB_MODULES: >-
      DefApps/default
      craype-accel-amd-gfx908
      rocm/4.5.0
      gcc/10
      cmake/3.22
      git
      git-lfs
      ninja
      zstd
    VTKM_SETTINGS: kokkos+hip+gfx908+spock+ccache+no_rendering
  interruptible: true

.setup_env_ecpci: &setup_env_ecpci |
  module purge
  module load ${JOB_MODULES}
  module list
  export PATH="${CCACHE_INSTALL_DIR}/ccache:$PATH"

build:spock_gcc_hip:
  stage: build
  tags: [spock, shell, olcf-spock-shell-02]
  extends:
    - .spock_gcc_hip
    - .run_spock_ci
  before_script:
    - *setup_env_ecpci
    - mkdir -p "$CCACHE_INSTALL_DIR"
    - cmake --version
    - cmake -VV -P .gitlab/ci/config/ccache.cmake
    - ccache -z
    - ccache -s
    - .gitlab/ci/config/kokkos.sh "$CI_BUILDS_DIR" "3.7.01" $KOKKOS_OPTS

    - git remote add lfs https://gitlab.kitware.com/vtk/vtk-m.git
    - git fetch lfs
    - git-lfs install
    - git-lfs pull lfs
  script:
    - cmake -V -P .gitlab/ci/config/gitlab_ci_setup.cmake
    - ctest -VV -S .gitlab/ci/ctest_configure.cmake
  artifacts:
    expire_in: 24 hours
    when: always
    paths:
      - build/
      - .gitlab/ccache/ccache

test:spock_gcc_hip:
  stage: test
  tags: [spock, slurm, olcf-spock-slurm-02]
  extends:
    - .spock_gcc_hip
    - .run_spock_ci
  needs:
    - build:spock_gcc_hip
  dependencies:
    - build:spock_gcc_hip
  variables:
    SCHEDULER_PARAMETERS: "-ACSC331 -pecp -t120 --nice=0 -c32 --gpus=4 -N 1"
    # We need this to skip ctest_submit from being run inside a jsrun job
    GITLAB_CI_EMULATION: 1
    # Tests errors to address due to different env in Spock
    # Refer to issue: https://gitlab.kitware.com/vtk/vtk-m/-/issues/743
    CTEST_EXCLUSIONS: >-
      UnitTestMIRFilter
      UnitTestDistributedBranchDecompositionFilter
      UnitTestWorkletParticleAdvection
      UnitTestLagrangianFilter
  before_script:
    - *setup_env_ecpci
  script:
    - CTEST_MAX_PARALLELISM=32 ctest -VV -S .gitlab/ci/ctest_build.cmake
    - CTEST_MAX_PARALLELISM=4  ctest -VV -S .gitlab/ci/ctest_test.cmake
  after_script:
    - *setup_env_ecpci
    - ccache -s
    - ctest -VV -S .gitlab/ci/ctest_submit_build.cmake
    - ctest -VV -S .gitlab/ci/ctest_submit_test.cmake
  timeout: 150 minutes
